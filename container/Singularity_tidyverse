Bootstrap:docker
From:nfcore/base:latest

%labels
	MAINTAINER Lauri Mesilaakso <lauri.mesilaakso@regionostergotland.se>
	DESCRIPTION Singularity container for building JASEN microbiology WGS pipeline's HTML report
	VERSION 0.1.0

%environment
        export PYTHONNOUSERSITE=True
        export PATH="/opt/conda/bin:/usr/bin:$PATH"
        export PATH="/opt/conda/envs/jasen/bin:$PATH"
        export PYTHONPATH="/opt/conda/envs/jasen/lib/python3.7/site-packages:/opt/conda/envs/jasen/lib"
        export BASH_ENV="/conda_init.sh:$BASH_ENV"
	export PICARD_HOME=/opt/conda/envs/jasen/share/picard-2.20.3-0/
	export PERL5LIB=$PERL5LIB:/opt/conda/envs/jasen/lib/site_perl/5.26.2/
        export TMPDIR=/tmp
        export TEMPDIR=/tmp
        export LC_ALL=C
	umask 0002

%files
        conda_init.sh /
        env_tidyverse.yml /environment.yml

%post
        apt -y update
        apt -y install build-essential make curl unzip locales
        apt-get clean
        rm -rf /var/lib/apt/lists/\* /tmp/\* /var/tmp/*
        ln -s /opt/conda/lib/libcrypto.so.1.1 /opt/conda/lib/libcrypto.so.1.0.0
        #locale-gen en_US.UTF-8
        #localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
 
        /opt/conda/bin/conda update -n base -c defaults conda
        /opt/conda/bin/conda install mamba -n base -c conda-forge
        /opt/conda/bin/mamba env create -f /environment.yml
        ln -s /opt/conda/envs/jasen/lib/libcrypto.so.1.1 /opt/conda/envs/jasen/lib/libcrypto.so.1.0.0

        # Conda setup attempts
        #/bin/cat conda_init.sh >> ~/.bashrc
        /opt/conda/bin/conda init bash
        . /opt/conda/etc/profile.d/conda.sh
        conda config --set auto_activate_base true
        conda clean -a

%runscript
        . /opt/conda/etc/profile.d/conda.sh
        . /opt/conda/bin/activate jasen
	exec "$@"`
        . /opt/conda/bin/deactivate
