#!/usr/bin/env nextflow
// Select multiple profiles by using -profile local, singularity

params {
  krakendb_url="ftp://ftp.ccb.jhu.edu/pub/data/kraken2_dbs/16S_Silva138_20200326.tgz"
  
  chewbbaca_db_download = true
  // Cgmlst urls for various species
  chewbbacadb_url_Enterococcus_faecalis="https://www.cgmlst.org/ncs/schema/3887469/alleles/"
  chewbbacadb_url_Staphylococcus_aureus="https://www.cgmlst.org/ncs/schema/141106/alleles/"
  chewbbacadb_url_Escherichia_coli="https://www.cgmlst.org/ncs/schema/5064703/alleles/"
  chewbbacadb_url_Mycobacterium_tuberculosis_bovis_africanum_canettii="https://www.cgmlst.org/ncs/schema/741110/alleles/"
  chewbbacadb_url_Klebsiella_pneumoniae_variicola_quasipneumoniae="https://www.cgmlst.org/ncs/schema/2187931/alleles/"

  local_ariba_db_dir = "${baseDir}/assets/var-genes-ro"
  ariba_db_download = true
  kraken_db_download = true
  // Reporting
  report_template_file = "${baseDir}/exp/create_output_doc/Test_output.Rmd"
  bibliography = "${baseDir}/exp/create_output_doc/bibliography.bib"
  reference_style = "${baseDir}/exp/create_output_doc/pnas.csl"

  resfinder_phenotypes = "https://bitbucket.org/genomicepidemiology/resfinder_db/raw/f26963481ec582d09889cf808d5680bc5adec4cc/phenotypes.txt"
  adapters = "${baseDir}/assets/adapters/qiaseq_adapters.fa"
}

profiles {
  Escherichia_coli{
    params.species = "Escherichia_coli"
    params.genome_name = "Escherichia_coli_GCF_000008865.2_ASM886v2" // test data: "AP017922.1" or "NC_011751.1"
    params.input_dir = "Escherichia_coli_p1"
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/5064703/alleles/"
  }
  Staphylococcus_aureus{
    params.species = "Staphylococcus_aureus"
    params.genome_name = "Staphylococcus_aureus_GCF_000013425.1_ASM1342v1"
    params.input_dir = "saureus_p1"
    sample_ID = "Staphylococcus_aureus_prov1"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/141106/alleles/"
  }
  Klebsiella_pneumoniae{
    params.species = "Klebsiella_pneumoniae"
    params.genome_name = "Klebsiella_pneumoniae_GCF_000240185.1_ASM24018v2"
    params.input_dir = "Klebsiella_pneumoniae_p1"
    sample_ID = "Klebsiella_pneumoniae_prov1"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/2187931/alleles/"
  }
  Mycobacterium_tuberculosis{
    params.species = "Mycobacterium_tuberculosis"
    params.genome_name = "Mycobacterium_tuberculosis_GCF_000195955.2_ASM19595v2"
    params.input_dir = "Mycobacterium_tuberculosis_p1"
    sample_ID = "Mycobacterium_tuberculosis_prov1"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/741110/alleles/"
  }
  Acinetobacter_baumannii{
    params.species = "Acinetobacter_baumannii"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/3956907/alleles/"
  }
  Enterococcus_faecalis{
    params.species = "Enterococcus_faecalis"
    params.genome_name = ""
    params.input_dir = "Enterococcus_faecalis"
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/3887469/alleles/"
  }
  Enterococcus_faecium{
    params.species = "Enterococcus_faecium"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/991893/alleles/"
  }
  Pseudomonas_aeruginosa{
    params.species = "Pseudomonas_aeruginosa"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/16115339/alleles/"
  }
  Clostridioides_difficile{
    params.species = "Clostridioides_difficile"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/12556067/alleles/"
  }
  Mycobacterium_africanum{
    params.species = "Mycobacterium_africanum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/741110/alleles/"
  }
  Mycobacterium_bovis{
    params.species = "Mycobacterium_bovis"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/741110/alleles/"
  }
  Salmonella_enterica{
    params.species = "Salmonella_enterica"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/4792159/alleles/"
  }
  Mycobacterium_gordonae{
    params.species = "Mycobacterium_gordonae"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_africanum{
    params.species = "Mycobacterium_africanum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/741110/alleles/"
  }
  Mycobacterium_bovis{
    params.species = "Mycobacterium_bovis"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/741110/alleles/"
  }
  Salmonella_enterica{
    params.species = "Salmonella_enterica"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = "https://www.cgmlst.org/ncs/schema/4792159/alleles/"
  }
  Enterobacter_cloacae{
    params.species = "Enterobacter_cloacae"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_abcessus{
    params.species = "Mycobacterium_abcessus"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_avium{
    params.species = "Mycobacterium_avium"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_intracellulare{
    params.species = "Mycobacterium_intracellulare"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_malmoense{
    params.species = "Mycobacterium_malmoense"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Staphylococcus_argenteus{
    params.species = "Staphylococcus_argenteus"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Stenotrophomonas_maltophilia{
    params.species = "Stenotrophomonas_maltophilia"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Streptococcus_pyogenes{
    params.species = "Streptococcus_pyogenes"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Citrobacter_braakii{
    params.species = "Citrobacter_braakii"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Corynebacterium_striatum{
    params.species = "Corynebacterium_striatum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Enterococcus_gallinarum{
    params.species = "Enterococcus_gallinarum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Klebsiella_aerogenes{
    params.species = "Klebsiella_aerogenes"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_chimera{
    params.species = "Mycobacterium_chimera"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_malmoense{
    params.species = "Mycobacterium_malmoense"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_kansasii{
    params.species = "Mycobacterium_kansasii"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_chelonae{
    params.species = "Mycobacterium_chelonae"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_celatum{
    params.species = "Mycobacterium_celatum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_marinum{
    params.species = "Mycobacterium_marinum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_szulgai{
    params.species = "Mycobacterium_szulgai"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_scrofulaceum{
    params.species = "Mycobacterium_scrofulaceum"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Mycobacterium_xenopi{
    params.species = "Mycobacterium_xenopi"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Proteus_mirabilis{
    params.species = "Proteus_mirabilis"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  Proteus_vulgaris{
    params.species = "Proteus_vulgaris"
    params.genome_name = ""
    params.input_dir = ""
    sample_ID = "${params.input_dir}"
    params.chewbbacadb_url = ""
  }
  local {
    params.location='local'
    process.executor='local'
  }
  slurm {
    params.location='slurm'
    process.executor='slurm'
    process.queue='high'
  }
  conda {
    params.pkm = 'conda'

    params.rootdir = '/tmp/jasen/'
    params.outdir = "${params.rootdir}/results/"
    params.assets = "${params.rootdir}/assets/"
    params.reference = "${params.assets}/ref_genomes/${params.genome_name}.fna"
    params.krakendb="${params.assets}/references/minikraken2/"
    params.aribadb="${params.assets}/references/ariba/"
    params.chewbbacadb="${params.assets}/references/chewbbaca/"
  }
  singularity {
    params.pkm = 'singularity'

    params.rootdir = "/out"
    params.work = "${params.rootdir}/scratch/"

    env.NXF_WORK="${params.work}"
    env.NXF_TEMP="${params.work}"
    env.NXF_SINGULARITY_LOCALCACHEDIR="${params.work}"
    env.NXF_SINGULARITY_CACHEDIR="${params.work}"
    env.NXF_SINGULARITY_TMPDIR="${params.work}"

    env.SINGULARITY_LOCALCACHEDIR="${params.work}"
    env.SINGULARITY_CACHEDIR="${params.work}"
    env.SINGULARITY_TMPDIR="${params.work}"
    env.SINGULARITY_ROOTFS="${params.work}"

    env.TMPDIR="${params.work}"
    env.TEMPDIR="${params.work}"

    params.output_path = 'results'

    params.outdir = "${params.rootdir}/${params.output_path}/"
    params.assets =  "${params.rootdir}/assets/"
    params.reference = "${params.assets}ref_genomes/${params.genome_name}.fna"
    params.krakendb = "${params.assets}references/minikraken2/"
    params.aribadb = "${params.assets}references/ariba"
    params.aribadb_local = "${params.assets}references/ariba_local"
    params.aribadb_nonc = "${params.assets}references/ariba_non-coding"
    params.chewbbacadb = "${params.assets}references/chewbbaca/"

    singularity.enabled = true
    singularity.runOptions = "-B ${baseDir}:/external -B /scratch/tmp/:/out -e  -W ${params.work} --pwd ${params.work} --env-file /JASEN/container/environment.yml"
    singularity.autoMounts = true
  }
}

params {
  input = "${baseDir}/assets/sequencing_data/${params.input_dir}"
// input = "${baseDir}/assets/sequencing_data/Escherichia_coli_p1"
// input = "${baseDir}/assets/test_data/sequencing_data/ecoli_1k"
// input = "${baseDir}/assets/sequencing_data/${params.input_dir}"
  prodigal_file = "${baseDir}/assets/prodigal_training_files/${params.genome_name}.trn"
}

process {
  withLable: min_allocation {
    cpus = 20
    memory = '100.GB'
    time = '15m'
  }
  withLabel: modest_allocation {
    cpus = 50
    memory = '200.GB'
    time = '1h'
  }
  withLabel: max_allocation {
    cpus = 66
    memory = '450.GB'
    time = '2h'
  }
}

manifest {
  name = 'genomic-medicine-sweden/JASEN'
  author = 'Isak Sylvin et al.'
  homePage = 'https://github.com/genomic-medicine-sweden/JASEN.git'
  description = 'Json producing Assembly driven microbial Sequence analysis pipeline to support Epitypification and Normalize classification decisions'
  mainScript = 'main.nf'
  nextflowVersion = '>=10.0.0'
  version = '0.1.0'
}
